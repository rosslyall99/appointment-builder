<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slanj Appointment Wizard</title>
    <link rel="stylesheet" href="src/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Open+Sans:wght@300..800&display=swap"
        rel="stylesheet">
</head>

<body>

    <div id="slanj-appointment-wizard" x-data="appointmentWizard">

        <!-- DEBUG (hidden) -->
        <div x-show="false">
            <div style="background:#eef;padding:10px;margin:10px 0;">
                <strong>FULL DATA DEBUG:</strong>
                <pre x-text="JSON.stringify(form, null, 2)"></pre>
            </div>

            <div style="background:#eee;padding:10px;margin:10px 0;">
                <strong>DEBUG:</strong>
                <div>currentId: <span x-text="currentId"></span></div>
                <div>current.type: <span x-text="current?.type"></span></div>
                <div>questionText: <span x-text="current?.questionText"></span></div>
            </div>
        </div>

        <div class="wizard-container">

            <!-- STEP: ANSWERS -->
            <template x-if="!isFinal && !current.type">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>

                    <div class="answers">
                        <template x-for="answer in current.answers">
                            <div class="answer-row">
                                <button class="answer-btn" @click="handleAnswer(answer)">
                                    <span x-text="answer.label"></span>
                                </button>

                                <button class="info-btn" x-show="answer.description" @click="showInfo(answer)">
                                    i
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- STEP: NUMBER -->
            <template x-if="current.type === 'number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>
                    <input type="number" min="0" x-model.number="form[current.model]" class="date-time-input" />
                </div>
            </template>

            <!-- STEP: MULTI-NUMBER -->
            <template x-if="current.type === 'multi-number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>

                    <template x-for="field in current.fields">
                        <div class="date-time-row multi-number-row">
                            <label x-text="field.label"></label>

                            <input type="number" min="0" x-model.number="form[field.model]" class="date-time-input" />

                            <button class="info-btn" x-show="field.description" @click="showInfo({
                                        label: field.label,
                                        description: field.description
                                    })">
                                i
                            </button>
                        </div>
                    </template>
                </div>
            </template>

            <!-- STEP: CUSTOM MULTI-NUMBER -->
            <template x-if="current.type === 'custom-multi-number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>

                    <div x-show="!partyAppointmentsMatch" class="alert-message">
                        <p>You have requested <strong x-text="form.adults"></strong> adult measurements and
                            <strong x-text="form.children"></strong> child measurements.
                        </p>
                        <p>Please assign the correct number of appointment types to continue.</p>
                    </div>

                    <!-- INITIAL -->
                    <div class="section">
                        <div class="section-header">
                            <h4 class="section-title">INITIAL MEASUREMENTS</h4>
                        </div>
                        <div class="party-type-row">
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Adults</label>
                                    <input class="date-time-input" type="number" min="0"
                                        x-model.number="form.partyAppointments.initial.adults" />
                                </div>
                            </div>
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Children</label>
                                    <input class="date-time-input" type="number" min="0"
                                        x-model.number="form.partyAppointments.initial.children" />
                                </div>
                            </div>
                        </div>
                        <button class="section-action" @click="
                                form.partyAppointments.initial.adults = form.adults;
                                form.partyAppointments.initial.children = form.children;">Everyone in Initial
                            Measurements</button>
                    </div>

                    <!-- REMEASURES -->
                    <div class="section">
                        <div class="section-header">
                            <h4 class="section-title">REMEASURES</h4>
                        </div>
                        <div class="party-type-row">
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Adults</label>
                                    <input class="date-time-input" type="number" min="0"
                                        x-model.number="form.partyAppointments.remeasure.adults" />
                                </div>
                            </div>
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Children</label>
                                    <input type="number" min="0"
                                        x-model.number="form.partyAppointments.remeasure.children" />
                                </div>
                            </div>
                        </div>
                        <button class="section-action" @click="
                                form.partyAppointments.remeasure.adults = form.adults;
                                form.partyAppointments.remeasure.children = form.children;">Everyone in
                            Remeasures</button>
                    </div>

                    <!-- FULL TRY ON -->
                    <div class="section">
                        <div class="section-header">
                            <h4 class="section-title">FULL TRY ONS</h4>
                        </div>
                        <div class="party-type-row">
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Adults</label> <input type="number" min="0"
                                        x-model.number="form.partyAppointments.fullTryOn.adults"
                                        @input="checkFullTryOnLimit('adults')" />
                                </div>
                            </div>
                            <div class="half-width-group">
                                <div class="input-with-info">
                                    <label>Children</label>
                                    <input type="number" min="0"
                                        x-model.number="form.partyAppointments.fullTryOn.children"
                                        @input="checkFullTryOnLimit('children')" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- STEP: BUY MULTI -->
            <template x-if="current.type === 'buy-multi' && form.buyItems.length === form.buyCount">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>

                    <template x-for="i in form.buyCount" :key="i">
                        <div class="buy-item-row">
                            <div class="buy-item-top">
                                <label>Person <span x-text="i"></span></label>
                                <select class="date-time-input" x-model="form.buyItems[i - 1].type"
                                    @change="ensureBuyItem(i - 1)">
                                    <option value="">Select an item</option>
                                    <option value="kilt">Kilt only</option>
                                    <option value="outfit">Kilt outfit</option>
                                    <option value="great_kilt">Great kilt</option>
                                    <option value="trousers">Trousers</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div x-show="form.buyItems[i - 1]?.type === 'other'" class="buy-item-details">
                                <textarea x-model="form.buyItems[i - 1].details" placeholder="Please describe the item"
                                    class="date-time-input"></textarea>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- STEP: FINAL FORM -->
            <template x-if="isFinal && !formSubmitted">
                <div class="wizard-card">
                    <h2 class="wizard-page-title">Contact Details</h2>
                    <p class="question-text">Please fill in your contact details.</p>
                    <p class="subtext">Once submitted, we will contact you to confirm your appointment.</p>

                    <form @submit.prevent="submitForm" class="final-form" x-ref="finalForm">

                        <div class="date-time-row">
                            <label>Name</label>
                            <input class="date-time-input" type="text" x-model="form.name" required />
                        </div>

                        <div class="date-time-row">
                            <label>Email</label>
                            <input class="date-time-input" type="email" x-model="form.email" required />
                        </div>

                        <div class="date-time-row">
                            <label>Phone</label>
                            <input class="date-time-input" type="text" x-model="form.phone" />
                        </div>

                        <div class="date-time-row">
                            <label>Comments</label>
                            <textarea class="date-time-input" x-model="form.notes"></textarea>
                        </div>
                    </form>
                </div>
            </template>

            <!-- STEP: SUCCESS -->
            <template x-if="formSubmitted">
                <div class="wizard-card success-message">
                    <h2>Thank you!</h2>
                    <p>Your message has been sent successfully.</p>
                </div>
            </template>

            <!-- STEP: DATE & TIME -->
            <template x-if="current.type === 'datetime'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>
                    <div class="alert-message">
                        <p x-show="isDukeSunday">Our Duke Street store is closed on Sundays.</p>
                    </div>

                    <div class="date-time-container">

                        <div class="date-time-row">
                            <label>Date</label>
                            <input type="date" class="date-time-input" x-model="form.date"
                                :min="new Date().toISOString().split('T')[0]" />
                        </div>

                        <template x-if="form.date && !(form.branch === 'DUK' && selectedDay === 0)">
                            <div class="date-time-row">
                                <label>Time</label>
                                <select class="date-time-input" x-model="form.time">
                                    <option value="">Select a time</option>
                                    <template x-for="slot in availableTimes" :key="slot">
                                        <option :value="slot" x-text="slot"></option>
                                    </template>
                                </select>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- CONFIRM BOX -->
            <div x-show="confirmBox.visible" class="confirm-overlay">
                <div class="confirm-box">

                    <template x-if="confirmBox.mapUrl">
                        <iframe :src="confirmBox.mapUrl" width="100%" height="300"
                            style="border:0; margin-bottom: 1rem;" allowfullscreen="" loading="lazy"></iframe>
                    </template>

                    <p x-html="confirmBox.message"></p>

                    <div x-show="confirmBox.mode === 'alert'">
                        <button @click="confirmBox.visible = false">OK</button>
                    </div>

                    <div x-show="confirmBox.mode === 'confirm'">
                        <button class="confirm-box-button" @click="confirmYes">Yes</button>
                        <button class="confirm-box-button" @click="confirmNo">No</button>
                    </div>

                </div>
            </div>

            <!-- INFO MODAL -->
            <div x-show="infoModal.visible" class="info-overlay">
                <div class="info-box">
                    <h3 class="info-box-title" x-text="infoModal.title"></h3>
                    <div class="info-box-content" x-html="infoModal.html"></div>
                    <button class="info-box-button" @click="infoModal.visible = false">Close</button>
                </div>
            </div>

            <!-- FIXED BACK BUTTON -->
            <div class="button-group-wrapper">
                <div class="button-group"
                    x-show="!formSubmitted && history.length > 0 && !infoModal.visible && !confirmBox.visible">
                    <button class="back-btn" @click="back()">← Back</button>
                    <template x-if="['number','multi-number','custom-multi-number','datetime'].includes(current.type)">
                        <button class="submit-btn" :disabled="
                                (current.type === 'custom-multi-number' && !partyAppointmentsMatch) ||
                                (current.type === 'datetime' && !dateTimeComplete)
                            " :class="{
                                'disabled-btn':
                                    (current.type === 'custom-multi-number' && !partyAppointmentsMatch) ||
                                    (current.type === 'datetime' && !dateTimeComplete)
                            }" @click="
                                (
                                    (current.type === 'custom-multi-number' && partyAppointmentsMatch) ||
                                    (current.type === 'datetime' && dateTimeComplete) ||
                                    (current.type !== 'custom-multi-number' && current.type !== 'datetime')
                                ) && next(current.next)
                            ">
                            Next →
                        </button>
                    </template>
                    <template x-if="isFinal && !formSubmitted">
                        <button class="submit-btn" :disabled="!finalFormComplete"
                            :class="{ 'disabled-btn': !finalFormComplete }"
                            @click="finalFormComplete && $refs.finalForm.requestSubmit()">
                            Send Enquiry
                        </button>
                    </template>
                    <template x-if="current.type === 'buy-multi' && form.buyItems.length === form.buyCount">
                        <button class="submit-btn" :disabled="!buyItemsComplete"
                            :class="{ 'disabled-btn': !buyItemsComplete }"
                            @click="buyItemsComplete && next(current.next)">
                            Next
                        </button>
                    </template>
                </div>
            </div>
            <template x-if="formSubmitted">
                <div class="confirmation-footer">
                    <div class="button-group">
                        <button class="submit-btn" @click="resetFormAndStart()">Submit Another</button>

                        <a href="https://www.slanjkilts.com" class="submit-btn home-btn" rel="noopener">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white"
                                viewBox="0 0 24 24">
                                <path d="M3 9.75L12 3l9 6.75V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.75z" />
                            </svg>
                        </a>
                    </div>
                </div>
            </template>
        </div>

        <script type="module" src="src/main.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>

</html>