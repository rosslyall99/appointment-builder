<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slanj Appointment Wizard</title>
    <link rel="stylesheet" href="src/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Open+Sans:wght@300..800&display=swap"
        rel="stylesheet">
</head>

<body>

    <div id="slanj-appointment-wizard" x-data="appointmentWizard">

        <!-- DEBUG (hidden) -->
        <div x-show="false">
            <div style="background:#eef;padding:10px;margin:10px 0;">
                <strong>FULL DATA DEBUG:</strong>
                <pre x-text="JSON.stringify(form, null, 2)"></pre>
            </div>

            <div style="background:#eee;padding:10px;margin:10px 0;">
                <strong>DEBUG:</strong>
                <div>currentId: <span x-text="currentId"></span></div>
                <div>current.type: <span x-text="current?.type"></span></div>
                <div>questionText: <span x-text="current?.questionText"></span></div>
            </div>
        </div>

        <div class="wizard-container">

            <!-- STEP: ANSWERS -->
            <template x-if="!isFinal && !current.type">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>
                    <p class="subtext" x-show="current.subtext" x-html="current.subtext"></p>

                    <div class="answers">
                        <template x-for="answer in current.answers">
                            <div class="answer-row">
                                <button class="answer-btn" @click="handleAnswer(answer)">
                                    <span x-text="answer.label"></span>
                                </button>

                                <button class="info-btn" x-show="answer.description" @click="showInfo(answer)">
                                    i
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- STEP: NUMBER -->
            <template x-if="current.type === 'number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <input type="number" min="0" x-model.number="form[current.model]" class="number-input" />

                    <button class="answer-btn" @click="next(current.next)">Continue</button>
                </div>
            </template>

            <!-- STEP: MULTI-NUMBER -->
            <template x-if="current.type === 'multi-number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <template x-for="field in current.fields">
                        <div class="number-field">
                            <label x-text="field.label"></label>
                            <input type="number" min="0" x-model.number="form[field.model]" class="number-input" />
                        </div>
                    </template>

                    <button class="answer-btn" @click="next(current.next)">Continue</button>
                </div>
            </template>

            <!-- STEP: CUSTOM MULTI-NUMBER -->
            <template x-if="current.type === 'custom-multi-number'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <!-- INITIAL -->
                    <div class="section">
                        <h3>INITIAL MEASUREMENTS</h3>
                        <label>Adults</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.initial.adults" />
                        <label>Children (under 14)</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.initial.children" />
                        <button @click="
              form.partyAppointments.initial.adults = form.adults;
              form.partyAppointments.initial.children = form.children;
            ">Everyone Initial Measurement</button>
                    </div>

                    <!-- REMEASURES -->
                    <div class="section">
                        <h3>REMEASURES</h3>
                        <label>Adults</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.remeasure.adults" />
                        <label>Children (under 14)</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.remeasure.children" />
                        <button @click="
              form.partyAppointments.remeasure.adults = form.adults;
              form.partyAppointments.remeasure.children = form.children;
            ">Everyone Remeasure</button>
                    </div>

                    <!-- FULL TRY ON -->
                    <div class="section">
                        <h3>FULL TRY ON</h3>
                        <label>Adults</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.fullTryOn.adults"
                            @input="checkFullTryOnLimit('adults')" />
                        <label>Children (under 14)</label>
                        <input type="number" min="0" x-model.number="form.partyAppointments.fullTryOn.children"
                            @input="checkFullTryOnLimit('children')" />
                    </div>

                    <div style="margin-top: 1rem;">
                        <button class="answer-btn" :disabled="!partyAppointmentsMatch" @click="handlePartyNext">
                            Next
                        </button>

                        <p x-show="!partyAppointmentsMatch" style="color: red; margin-top: 0.5rem;">
                            You have chosen <strong x-text="form.adults"></strong> adults and
                            <strong x-text="form.children"></strong> children — please choose the appropriate number of
                            appointment
                            types to continue.
                        </p>
                    </div>
                </div>
            </template>

            <!-- STEP: BUY MULTI -->
            <template x-if="current.type === 'buy-multi' && form.buyItems.length === form.buyCount">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <template x-for="i in form.buyCount" :key="i">
                        <div class="buy-item">
                            <label>Person <span x-text="i"></span></label>

                            <select x-model="form.buyItems[i - 1].type" @change="ensureBuyItem(i - 1)">
                                <option value="">Select an item</option>
                                <option value="kilt">Kilt only</option>
                                <option value="outfit">Kilt outfit</option>
                                <option value="great_kilt">Great kilt</option>
                                <option value="trousers">Trousers</option>
                                <option value="other">Other</option>
                            </select>

                            <textarea x-show="form.buyItems[i - 1]?.type === 'other'"
                                x-model="form.buyItems[i - 1].details"
                                placeholder="Please describe the item"></textarea>
                        </div>
                    </template>

                    <button class="answer-btn" :disabled="!buyItemsComplete" @click="next(current.next)">
                        Next
                    </button>
                </div>
            </template>

            <!-- STEP: FINAL FORM -->
            <template x-if="isFinal && !formSubmitted">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="finalData?.title"></h2>
                    <p x-text="finalData?.description"></p>

                    <form @submit.prevent="submitForm" class="final-form">

                        <div class="form-field">
                            <label>Your Name</label>
                            <input type="text" x-model="form.name" required />
                        </div>

                        <div class="form-field">
                            <label>Email</label>
                            <input type="email" x-model="form.email" required />
                        </div>

                        <div class="form-field">
                            <label>Phone</label>
                            <input type="text" x-model="form.phone" />
                        </div>

                        <div class="form-field">
                            <label>Notes</label>
                            <textarea x-model="form.notes"></textarea>
                        </div>

                        <button type="submit" class="submit-btn">Send Enquiry</button>
                    </form>
                </div>
            </template>

            <!-- STEP: SUCCESS -->
            <template x-if="formSubmitted">
                <div class="wizard-card success-message">
                    <h2>Thank you!</h2>
                    <p>Your message has been sent successfully.</p>
                </div>
            </template>

            <!-- STEP: DATE & TIME -->
            <template x-if="current.type === 'datetime'">
                <div class="wizard-card">
                    <h2 class="wizard-page-title" x-text="current.pageTitle"></h2>
                    <h2 class="question-text" x-text="current.questionText"></h2>

                    <div class="date-time-container">

                        <div class="date-time-row">
                            <label>Date</label>
                            <input type="date" class="date-time-input" x-model="form.date"
                                :min="new Date().toISOString().split('T')[0]" />
                        </div>

                        <template x-if="form.date && !(form.branch === 'DUK' && selectedDay === 0)">
                            <div class="date-time-row">
                                <label>Time</label>
                                <select class="date-time-input" x-model="form.time">
                                    <option value="">Select a time</option>
                                    <template x-for="slot in availableTimes" :key="slot">
                                        <option :value="slot" x-text="slot"></option>
                                    </template>
                                </select>
                            </div>
                        </template>
                    </div>

                    <button class="answer-btn"
                        :disabled="!form.date || !form.time || (form.branch === 'DUK' && selectedDay === 0)"
                        @click="next(current.next)">
                        Next
                    </button>
                </div>
            </template>

            <!-- CONFIRM BOX -->
            <div x-show="confirmBox.visible" class="confirm-overlay">
                <div class="confirm-box">

                    <template x-if="confirmBox.mapUrl">
                        <iframe :src="confirmBox.mapUrl" width="100%" height="400"
                            style="border:0; margin-bottom: 1rem;" allowfullscreen="" loading="lazy"></iframe>
                    </template>

                    <p x-text="confirmBox.message"></p>

                    <div x-show="confirmBox.mode === 'alert'">
                        <button @click="confirmBox.visible = false">OK</button>
                    </div>

                    <div x-show="confirmBox.mode === 'confirm'">
                        <button class="confirm-box-button" @click="confirmYes">Yes</button>
                        <button class="confirm-box-button" @click="confirmNo">No</button>
                    </div>

                </div>
            </div>

            <!-- INFO MODAL -->
            <div x-show="infoModal.visible" class="info-overlay">
                <div class="info-box">
                    <h3 class="info-box-title" x-text="infoModal.title"></h3>
                    <div class="info-box-content" x-html="infoModal.html"></div>
                    <button class="info-box-button" @click="infoModal.visible = false">Close</button>
                </div>
            </div>

            <!-- FIXED BACK BUTTON -->
            <div class="button-group-wrapper">
                <div class="button-group" x-show="history.length > 0 && !infoModal.visible && !confirmBox.visible">
                    <button class="back-btn" @click="back()">← Back</button>
                </div>
            </div>

        </div>

        <script type="module" src="src/main.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>

</html>